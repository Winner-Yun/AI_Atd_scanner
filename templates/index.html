<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Attendance Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      :root {
        --primary-color: #00f2ff; /* Cyber Cyan */
        --bg-dark: #0f172a; /* Slate 900 (Main BG) */
        --card-bg: #1e293b; /* Slate 800 (Card BG) */
        --input-bg: #334155; /* Slate 700 (Input BG) */
        --text-main: #f1f5f9; /* Slate 100 */
        --text-muted: #94a3b8; /* Slate 400 */
      }

      body {
        background-color: var(--bg-dark);
        color: var(--text-main);
        font-family: "Rajdhani", sans-serif;
        overflow-x: hidden;
      }

      /* --- Navbar --- */
      .navbar {
        background: var(--card-bg);
        border-bottom: 1px solid rgba(0, 242, 255, 0.3);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        padding-top: 1rem;
        padding-bottom: 1rem;
      }
      .navbar-brand {
        font-family: "JetBrains Mono", monospace;
        font-weight: 700;
        color: var(--primary-color) !important;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
      }

      /* --- Cards --- */
      .card-custom {
        background-color: var(--card-bg);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }
      .card-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 1rem 1.5rem;
      }

      /* --- Inputs & Selects --- */
      .form-control-dark,
      .form-select-dark {
        background-color: var(--input-bg);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        font-family: "JetBrains Mono";
        font-size: 0.9rem;
      }
      .form-control-dark:focus,
      .form-select-dark:focus {
        background-color: #475569;
        border-color: var(--primary-color);
        color: white;
        box-shadow: 0 0 0 0.25rem rgba(0, 242, 255, 0.2);
      }

      /* --- Video Area --- */
      .video-wrapper {
        position: relative;
        background-color: #111827;
        border: 2px solid var(--input-bg);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        aspect-ratio: 16/9;
      }
      .video-feed {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      /* Scanner Line Animation */
      .scan-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          to bottom,
          transparent,
          rgba(0, 242, 255, 0.2),
          transparent
        );
        border-bottom: 2px solid var(--primary-color);
        animation: scan 2.5s infinite linear;
        pointer-events: none;
        z-index: 10;
        opacity: 0.7;
      }
      @keyframes scan {
        0% { top: -10%; }
        100% { top: 110%; }
      }

      /* --- Table --- */
      .table-container {
        max-height: 550px;
        overflow-y: auto;
        scrollbar-width: thin;
      }
      .table-dark-custom {
        --bs-table-bg: transparent;
        --bs-table-color: var(--text-main);
        border-color: rgba(255, 255, 255, 0.1);
      }
      .table-dark-custom th {
        color: var(--text-muted);
        font-family: "JetBrains Mono";
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        background-color: rgba(0, 0, 0, 0.2);
      }
      .table-hover tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.05);
      }

      /* --- Badges & Buttons --- */
      .status-badge {
        font-family: "JetBrains Mono";
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 0.4em 0.8em;
      }

      .btn-tech {
        background: transparent;
        border: 1px solid var(--primary-color);
        color: var(--primary-color);
        font-family: "JetBrains Mono";
        transition: all 0.3s;
      }
      .btn-tech:hover {
        background: var(--primary-color);
        color: #000;
        box-shadow: 0 0 15px rgba(0, 242, 255, 0.4);
      }

      .btn-add {
        background: linear-gradient(45deg, #10b981, #059669);
        border: none;
        color: white;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      }
      .btn-add:hover {
        background: linear-gradient(45deg, #059669, #047857);
        transform: translateY(-1px);
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #0f172a; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="fa-solid fa-layer-group me-2"></i> Attendance<span style="color:white">OS</span>
        </a>
        <div class="d-flex align-items-center gap-2">
          <a href="{{ url_for('main.manage_students') }}" class="btn btn-outline-danger btn-sm px-3 rounded-pill me-2">
            <i class="fa-solid fa-database me-2"></i>Database
          </a>
          <a href="{{ url_for('main.add_user') }}" class="btn btn-add rounded-pill px-4">
            <i class="fa-solid fa-user-plus me-2"></i> Register Student
          </a>
        </div>
      </div>
    </nav>

    <div class="container">
      
      <div class="card custom-card mb-4 border-0" style="background: var(--card-bg); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
        <div class="card-body p-3 d-flex flex-wrap justify-content-between align-items-center gap-3">
          
          <form action="{{ url_for('main.index') }}" method="get" class="d-flex align-items-center gap-3 flex-grow-1">
            <input type="hidden" name="search_date" value="{{ search_date }}">
            <input type="hidden" name="show_absent" value="{{ show_absent }}">

            <div class="d-flex align-items-center gap-2">
                <i class="fa-solid fa-filter text-primary"></i>
                <label class="text-white small mb-0" style="font-weight: 600;">CLASS:</label>
            </div>
            
            <select name="session_key" class="form-select" style="max-width: 300px;" onchange="this.form.submit()">
              <option value="" disabled {% if not current_selection %}selected{% endif %}>-- Select Active Class --</option>
              {% for c_id, data in classes.items() %} 
                {% if data.subjects %}
                  <optgroup label="{{ c_id }}">
                    {% for subj in data.subjects %}
                    <option value="{{ c_id }}|{{ loop.index0 }}" {% if current_selection == c_id + '|' + loop.index0|string %}selected{% endif %}>
                      {{ c_id }} • {{ subj.subject }} ({{ subj.teacher }})
                    </option>
                    {% endfor %}
                  </optgroup>
                {% else %}
                  <option disabled>{{ c_id }} (No Subjects Configured)</option>
                {% endif %} 
              {% else %}
                <option disabled>No Classes Found</option>
              {% endfor %}
            </select>
          </form>

          <a href="{{ url_for('main.manage_classes') }}" class="btn btn-outline-light btn-sm px-3" style="border-color: rgba(255,255,255,0.2);">
            <i class="fa-solid fa-gear me-1"></i> Settings
          </a>
        </div>
      </div>

      {% if current_subject %}
      <div class="alert fade show mb-4 d-flex justify-content-center gap-4 align-items-center" role="alert" 
           style="background: rgba(0, 242, 255, 0.05); border: 1px solid rgba(0, 242, 255, 0.2); color: var(--primary-color);">
          <div><i class="fa-solid fa-chalkboard-user me-2"></i><span class="text-white">{{ current_subject.teacher }}</span></div>
          <div class="vr bg-secondary opacity-50"></div>
          <div><i class="fa-solid fa-book me-2"></i><span class="text-white">{{ current_subject.subject }}</span></div>
          <div class="vr bg-secondary opacity-50"></div>
          <div><i class="fa-regular fa-clock me-2 text-danger"></i>Start Time: <span class="text-white">{{ current_subject.start_time }}</span></div>
          <div><i class="fa-regular fa-clock me-2 text-danger"></i>Late After: <span class="text-white">{{ current_subject.late_time }}</span></div>
      </div>
      {% endif %}

      <div class="row g-4">
        
        <div class="col-lg-7">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0 text-white"><i class="fa-solid fa-video me-2 text-primary"></i>Live Feed</h5>
            <span class="badge bg-danger rounded-pill pulse-badge">● LIVE</span>
          </div>
          <div class="video-wrapper">
            <div class="scan-overlay"></div>
            <img src="{{ url_for('main.video_feed') }}" class="video-feed" alt="System Offline" />
          </div>
        </div>

        <div class="col-lg-5">
          <div class="card card-custom h-100">
            
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="m-0 text-white"><i class="fa-solid fa-clipboard-list me-2 text-warning"></i>Logs</h5>
              
              <div class="d-flex align-items-center gap-2">
                  <form action="{{ url_for('main.index') }}" method="get" class="m-0">
                      {% if current_selection %}
                      <input type="hidden" name="session_key" value="{{ current_selection }}">
                      {% endif %}
                      <input type="hidden" name="show_absent" value="{{ show_absent }}">
                      
                      <select name="search_date" class="form-select form-select-sm form-select-dark py-1" style="font-size: 0.85rem;" onchange="this.form.submit()">
                          {% for date in available_dates %}
                             <option value="{{ date }}" {% if date == search_date %}selected{% endif %}>
                                {{ date }} {% if loop.index0 == 0 and date == available_dates[0] %}(Today){% endif %}
                             </option>
                          {% endfor %}
                      </select>
                  </form>

                   <a href="{{ url_for('main.index', session_key=current_selection, search_date=search_date, show_absent=('0' if show_absent=='1' else '1')) }}" 
                     class="btn btn-sm btn-outline-secondary" 
                     title="{{ 'Hide' if show_absent == '1' else 'Show' }} Absent Students">
                     {% if show_absent == '1' %}
                     <i class="fa-solid fa-eye-slash"></i>
                     {% else %}
                     <i class="fa-solid fa-eye"></i>
                     {% endif %}
                  </a>

                  <a href="{{ url_for('main.download_report') }}" class="btn btn-sm btn-success text-white" title="Export CSV">
                    <i class="fa-solid fa-download"></i>
                  </a>
              </div>
            </div>

            <div class="card-body p-0">
              <div class="table-container p-0">
                <table class="table table-dark-custom table-hover align-middle mb-0">
                  <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 2;">
                    <tr>
                      <th class="ps-4">Student Name</th>
                      <th class="text-center">Status</th>
                      <th class="text-end pe-4">Time</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in records %}
                    <tr>
                      <td class="ps-4 fw-bold text-light">{{ row.Name }}</td>
                      <td class="text-center">
                        {% if row.Status == 'Present' %}
                            <span class="badge bg-success bg-opacity-75 status-badge rounded-1" style="min-width: 80px;">PRESENT</span>
                        {% elif row.Status == 'Late' %}
                            <span class="badge bg-warning text-dark status-badge rounded-1" style="min-width: 80px;">LATE</span>
                        {% else %}
                            <span class="badge bg-danger bg-opacity-75 status-badge rounded-1" style="min-width: 80px;">ABSENT</span>
                        {% endif %}
                      </td>
                      <td class="text-end pe-4 text-white-50" style="font-family: 'JetBrains Mono'">{{ row.Time }}</td>
                    </tr>
                    {% else %}
                    <tr>
                      <td colspan="3" class="text-center py-5 text-light">
                        <i class="fa-solid fa-inbox fa-2x mb-3 opacity-25"></i><br />
                        No records found for this selection.
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
            
            <div class="card-footer bg-transparent border-top border-secondary border-opacity-10 text-center p-3">
              <a href="{{ url_for('main.index') }}?session_key={{ current_selection }}&search_date={{ search_date }}&show_absent={{ show_absent }}" 
                 class="btn btn-tech w-100 py-2">
                <i class="fa-solid fa-rotate-right me-2"></i> Sync Data
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    let lastUpdate = 0;
    setInterval(function () {
      fetch("{{ url_for('main.check_update') }}?t=" + new Date().getTime())
        .then((response) => response.json())
        .then((data) => {
          if (lastUpdate === 0) { lastUpdate = data.last_update; }
          else if (data.last_update > lastUpdate) { location.reload(); }
        })
        .catch((error) => console.error("Sync error", error));
    }, 2000);
  </script>
</html>